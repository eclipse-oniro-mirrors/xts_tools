/**
 * Copyright (c) 2025 Shenzhen Kaihong Digital Industry Development Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import router from '@ohos.router'
import { BusinessError } from '@ohos.base';

@Entry
@Component
struct routerTargetPage30 {
  @State currentLength: number = 0;
  @State beforeLength: number = 0;
  @State operation: string = '';
  @State receivedParams: string = '';
  @State operationLog: string = '';
  @State lengthComparison: string = '';

  aboutToAppear() {
    this.loadReceivedParams();
    this.getCurrentLength();
    this.addLog('getLength æµ‹è¯•ç›®æ ‡é¡µé¢åˆå§‹åŒ–å®Œæˆ');
  }

  // åŠ è½½æ¥æ”¶åˆ°çš„å‚æ•°
  loadReceivedParams() {
    try {
      const params = router.getParams();
      if (params) {
        this.beforeLength = params['beforeLength'] || 0;
        this.operation = params['operation'] || 'æœªçŸ¥æ“ä½œ';
        this.receivedParams = `æ¥æ”¶åˆ°çš„å‚æ•°ï¼š\n${JSON.stringify(params, null, 2)}`;
        console.info('ç›®æ ‡é¡µé¢æ¥æ”¶åˆ°å‚æ•°:', JSON.stringify(params));
        this.addLog(`æˆåŠŸæ¥æ”¶å‚æ•°ï¼Œæ¥æºæ“ä½œ: ${this.operation}`);
      } else {
        this.receivedParams = 'æœªæ¥æ”¶åˆ°ä»»ä½•å‚æ•°';
        this.addLog('æœªæ¥æ”¶åˆ°ä»»ä½•å‚æ•°');
      }
    } catch (err) {
      this.receivedParams = 'è·å–å‚æ•°å¤±è´¥';
      this.addLog('è·å–å‚æ•°å¤±è´¥');
      console.error('è·å–å‚æ•°å¤±è´¥:', JSON.stringify(err));
    }
  }

  // è·å–å½“å‰é¡µé¢æ ˆé•¿åº¦
  getCurrentLength() {
    try {
      const length = router.getLength();
      this.currentLength = length;
      
      // æ¯”è¾ƒè·³è½¬å‰åçš„é•¿åº¦å˜åŒ–
      this.updateLengthComparison();
      
      console.info(`ç›®æ ‡é¡µé¢ router.getLength() è¿”å›å€¼: ${length}`);
      this.addLog(`å½“å‰é¡µé¢æ ˆé•¿åº¦: ${length}`);
      
    } catch (err) {
      this.currentLength = -1;
      console.error('getLength() è°ƒç”¨å¤±è´¥:', JSON.stringify(err));
      this.addLog(`è·å–é¡µé¢æ ˆé•¿åº¦å¤±è´¥: ${JSON.stringify(err)}`);
    }
  }

  // æ›´æ–°é•¿åº¦å¯¹æ¯”ä¿¡æ¯
  updateLengthComparison() {
    if (this.beforeLength > 0) {
      const difference = this.currentLength - this.beforeLength;
      
      if (difference > 0) {
        this.lengthComparison = `âœ… æ ˆæ·±åº¦å¢åŠ äº† ${difference} å±‚ (${this.beforeLength} â†’ ${this.currentLength})`;
      } else if (difference === 0) {
        this.lengthComparison = `âšª æ ˆæ·±åº¦ä¿æŒä¸å˜ (${this.beforeLength} â†’ ${this.currentLength})`;
      } else {
        this.lengthComparison = `ğŸ“‰ æ ˆæ·±åº¦å‡å°‘äº† ${Math.abs(difference)} å±‚ (${this.beforeLength} â†’ ${this.currentLength})`;
      }
    } else {
      this.lengthComparison = `å½“å‰æ ˆæ·±åº¦: ${this.currentLength}`;
    }
  }

  // æ·»åŠ æ“ä½œæ—¥å¿—
  addLog(message: string) {
    const timestamp = new Date().toLocaleTimeString();
    this.operationLog = `[${timestamp}] ${message}\n${this.operationLog}`;
  }

  // ç»§ç»­è·³è½¬åˆ°è‡ªå·±ï¼Œæµ‹è¯•æ ˆæ·±åº¦ç´¯ç§¯
  continuePush() {
    this.addLog('ç»§ç»­è·³è½¬åˆ°è‡ªå·±ï¼Œæµ‹è¯•æ ˆæ·±åº¦ç´¯ç§¯...');
    
    const currentLength = this.currentLength;
    
    router.pushUrl({
      url: 'testability/pages/RoutingSupportstageInterface/RoutingSupportstageInterface30_target',
      params: {
        fromPage: 'RoutingSupportstageInterface30_target',
        beforeLength: currentLength,
        testId: 30,
        operation: 'continuePush',
        level: currentLength + 1,
        timestamp: Date.now()
      }
    }).then(() => {
      console.info('ç»§ç»­è·³è½¬æˆåŠŸ');
      this.addLog(`ç»§ç»­è·³è½¬æˆåŠŸï¼Œè·³è½¬å‰æ ˆé•¿åº¦: ${currentLength}`);
    }).catch((err: BusinessError) => {
      console.error('ç»§ç»­è·³è½¬å¤±è´¥:', JSON.stringify(err));
      this.addLog(`ç»§ç»­è·³è½¬å¤±è´¥: ${err.message}`);
    });
  }

  // è¿”å›ä¸Šä¸€é¡µå¹¶è§‚å¯Ÿæ ˆæ·±åº¦å˜åŒ–
  goBackAndCheck() {
    this.addLog(`å‡†å¤‡è¿”å›ä¸Šä¸€é¡µï¼Œå½“å‰æ ˆé•¿åº¦: ${this.currentLength}`);
    
    try {
      router.back();
      console.info('è¿”å›æ“ä½œå·²æ‰§è¡Œ');
      this.addLog('è¿”å›æ“ä½œå·²æ‰§è¡Œ');
    } catch (err) {
      console.error('è¿”å›å¤±è´¥:', JSON.stringify(err));
      this.addLog(`è¿”å›å¤±è´¥: ${JSON.stringify(err)}`);
    }
  }

  // è¿”å›åˆ°ä¸»é¡µé¢
  backToMainPage() {
    this.addLog('å‡†å¤‡è¿”å›åˆ°ä¸»é¡µé¢...');
    
    router.back({
      url: 'testability/pages/RoutingSupportstageInterface/RoutingSupportstageInterface30'
    }).then(() => {
      console.info('è¿”å›åˆ°ä¸»é¡µé¢æˆåŠŸ');
      this.addLog('è¿”å›åˆ°ä¸»é¡µé¢æˆåŠŸ');
    }).catch((err: BusinessError) => {
      console.error('è¿”å›åˆ°ä¸»é¡µé¢å¤±è´¥:', JSON.stringify(err));
      this.addLog(`è¿”å›åˆ°ä¸»é¡µé¢å¤±è´¥: ${err.message}`);
    });
  }

  // æ›¿æ¢åˆ°è‡ªå·±ï¼Œæµ‹è¯•æ ˆæ·±åº¦ä¸å˜
  replaceSelf() {
    this.addLog('æ›¿æ¢åˆ°è‡ªå·±ï¼Œæµ‹è¯•æ ˆæ·±åº¦æ˜¯å¦ä¿æŒä¸å˜...');
    
    const currentLength = this.currentLength;
    
    router.replaceUrl({
      url: 'testability/pages/RoutingSupportstageInterface/RoutingSupportstageInterface30_target',
      params: {
        fromPage: 'RoutingSupportstageInterface30_target',
        beforeLength: currentLength,
        testId: 30,
        operation: 'replaceSelf',
        timestamp: Date.now()
      }
    }).then(() => {
      console.info('æ›¿æ¢æ“ä½œæˆåŠŸ');
      this.addLog(`æ›¿æ¢æ“ä½œæˆåŠŸï¼Œæ›¿æ¢å‰æ ˆé•¿åº¦: ${currentLength}`);
    }).catch((err: BusinessError) => {
      console.error('æ›¿æ¢æ“ä½œå¤±è´¥:', JSON.stringify(err));
      this.addLog(`æ›¿æ¢æ“ä½œå¤±è´¥: ${err.message}`);
    });
  }

  build() {
    Column() {
      Text('getLength æµ‹è¯•ç›®æ ‡é¡µé¢')
        .fontSize(22)
        .fontWeight(FontWeight.Bold)
        .fontColor('#007dff')
        .margin({ bottom: 15 })

      Text('âœ… è·³è½¬æˆåŠŸï¼æ­£åœ¨éªŒè¯æ ˆæ·±åº¦å˜åŒ–')
        .fontSize(16)
        .fontColor('#4caf50')
        .fontWeight(FontWeight.Medium)
        .margin({ bottom: 15 })

      // æ“ä½œç±»å‹æ˜¾ç¤º
      if (this.operation !== '') {
        Text(`æ¥æºæ“ä½œ: ${this.operation}`)
          .fontSize(14)
          .fontColor('#e91e63')
          .fontWeight(FontWeight.Medium)
          .backgroundColor('#fce4ec')
          .padding(8)
          .borderRadius(6)
          .margin({ bottom: 15 })
      }

      // å½“å‰æ ˆé•¿åº¦æ˜¾ç¤º
      Row() {
        Text('å½“å‰æ ˆæ·±åº¦:')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
        
        Text(`${this.currentLength >= 0 ? this.currentLength : 'è·å–å¤±è´¥'}`)
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .fontColor('#007dff')
          .margin({ left: 10 })
        
        Text('é¡µé¢')
          .fontSize(16)
          .fontColor('#666666')
          .margin({ left: 5 })
      }
      .margin({ bottom: 15 })

      // é•¿åº¦å˜åŒ–å¯¹æ¯”
      Text(this.lengthComparison)
        .fontSize(14)
        .fontColor(
          this.lengthComparison.includes('âœ…') ? '#4caf50' : 
          this.lengthComparison.includes('ğŸ“‰') ? '#f44336' : '#ff9800'
        )
        .backgroundColor('#f8f9fa')
        .padding(10)
        .borderRadius(8)
        .margin({ bottom: 15 })
        .width('90%')

      // æ“ä½œæŒ‰é’®
      Button('åˆ·æ–°æ ˆé•¿åº¦ä¿¡æ¯')
        .onClick(() => {
          this.getCurrentLength();
          this.addLog('å·²åˆ·æ–°æ ˆé•¿åº¦ä¿¡æ¯');
        })
        .width('80%')
        .backgroundColor('#007dff')
        .fontColor('#ffffff')

      Button('ç»§ç»­è·³è½¬ (pushUrl)')
        .onClick(() => {
          this.continuePush();
        })
        .width('80%')
        .backgroundColor('#4caf50')
        .fontColor('#ffffff')
        .margin({ top: 8 })

      Button('æ›¿æ¢åˆ°è‡ªå·± (replaceUrl)')
        .onClick(() => {
          this.replaceSelf();
        })
        .width('80%')
        .backgroundColor('#ff9800')
        .fontColor('#ffffff')
        .margin({ top: 8 })

      Button('è¿”å›ä¸Šä¸€é¡µ (back)')
        .onClick(() => {
          this.goBackAndCheck();
        })
        .width('80%')
        .backgroundColor('#f44336')
        .fontColor('#ffffff')
        .margin({ top: 8 })

      Button('è¿”å›åˆ°ä¸»é¡µé¢')
        .onClick(() => {
          this.backToMainPage();
        })
        .width('80%')
        .backgroundColor('#9c27b0')
        .fontColor('#ffffff')
        .margin({ top: 8 })

      Divider()
        .margin({ top: 15, bottom: 10 })

      // æ¥æ”¶åˆ°çš„å‚æ•°æ˜¾ç¤º
      Text('æ¥æ”¶åˆ°çš„å‚æ•°:')
        .fontSize(14)
        .fontWeight(FontWeight.Bold)
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 8 })

      Scroll() {
        Text(this.receivedParams)
          .fontSize(10)
          .textAlign(TextAlign.Start)
          .backgroundColor('#f5f5f5')
          .padding(8)
          .borderRadius(6)
          .width('100%')
      }
      .width('90%')
      .height(100)
      .margin({ bottom: 15 })

      // æ“ä½œæ—¥å¿—åŒºåŸŸ
      Text('æ“ä½œæ—¥å¿—:')
        .fontSize(14)
        .fontWeight(FontWeight.Bold)
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 8 })

      Scroll() {
        Text(this.operationLog || 'æš‚æ— æ“ä½œè®°å½•')
          .fontSize(11)
          .textAlign(TextAlign.Start)
          .backgroundColor('#f9f9f9')
          .padding(8)
          .borderRadius(6)
          .width('100%')
          .constraintSize({ minHeight: 80, maxHeight: 120 })
      }
      .width('90%')
      .height(120)

      // éªŒè¯è¯´æ˜
      Text('éªŒè¯é¡¹ç›®:')
        .fontSize(12)
        .fontWeight(FontWeight.Bold)
        .alignSelf(ItemAlign.Start)
        .margin({ top: 10, bottom: 5 })

      Text('â€¢ pushUrl: æ ˆæ·±åº¦åº”è¯¥+1\n' +
        'â€¢ replaceUrl: æ ˆæ·±åº¦ä¿æŒä¸å˜\n' +
        'â€¢ back: æ ˆæ·±åº¦åº”è¯¥-1\n' +
        'â€¢ getLength(): è¿”å›æ­£ç¡®çš„æ ˆæ·±åº¦å€¼')
        .fontSize(10)
        .fontColor('#666666')
        .textAlign(TextAlign.Start)
        .alignSelf(ItemAlign.Start)
        .lineHeight(15)

    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Start)
    .padding(15)
    .scrollable(ScrollDirection.Vertical)
  }
}
