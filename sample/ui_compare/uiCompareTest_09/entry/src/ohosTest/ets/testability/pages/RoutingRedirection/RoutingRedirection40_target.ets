/**
 * Copyright (c) 2025 Shenzhen Kaihong Digital Industry Development Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import router from '@ohos.router'
import { BusinessError } from '@ohos.base';

@Entry
@Component
struct routingRedirection40Target {
  @State receivedParams: string = '';
  @State routerStackInfo: string = '';
  @State operationLog: string = '';
  @State uploadStatus: string = '';
  @State backStatus: string = '';

  aboutToAppear() {
    this.loadReceivedParams();
    this.updateRouterStackInfo();
    this.addLog('Routeré‡å®šå‘æµ‹è¯•ç›®æ ‡é¡µé¢åˆå§‹åŒ–å®Œæˆ');
  }

  // åŠ è½½æ¥æ”¶åˆ°çš„å‚æ•°
  loadReceivedParams() {
    try {
      const params = router.getParams();
      if (params) {
        this.receivedParams = `æ¥æ”¶åˆ°çš„å‚æ•°ï¼š\n${JSON.stringify(params, null, 2)}`;
        console.info('ç›®æ ‡é¡µé¢æ¥æ”¶åˆ°å‚æ•°:', JSON.stringify(params));
        this.addLog('æˆåŠŸæ¥æ”¶æ¥è‡ªä¸»é¡µé¢çš„å‚æ•°');
      } else {
        this.receivedParams = 'æœªæ¥æ”¶åˆ°ä»»ä½•å‚æ•°';
        this.addLog('æœªæ¥æ”¶åˆ°ä»»ä½•å‚æ•°');
      }
    } catch (err) {
      this.receivedParams = 'è·å–å‚æ•°å¤±è´¥';
      this.addLog('è·å–å‚æ•°å¤±è´¥');
      console.error('è·å–å‚æ•°å¤±è´¥:', JSON.stringify(err));
    }
  }

  // è·å–å½“å‰è·¯ç”±æ ˆä¿¡æ¯
  updateRouterStackInfo() {
    try {
      const length = router.getLength();
      const state = router.getState();
      this.routerStackInfo = `è·¯ç”±æ ˆæ·±åº¦: ${length}\nå½“å‰é¡µé¢: ${state.name || 'æœªçŸ¥'}\nå½“å‰è·¯å¾„: ${state.path || 'æœªçŸ¥'}`;
    } catch (err) {
      this.routerStackInfo = 'è·å–è·¯ç”±ä¿¡æ¯å¤±è´¥';
    }
  }

  // æ·»åŠ æ“ä½œæ—¥å¿—
  addLog(message: string) {
    const timestamp = new Date().toLocaleTimeString();
    this.operationLog = `[${timestamp}] ${message}\n${this.operationLog}`;
  }

  // ä¸Šä¼ é¡µé¢è·¯å¾„ç»™å…ƒèƒ½åŠ›
  uploadPagePathToMetaAbility(pagePath: string, operation: string, backResult: any) {
    this.addLog(`å¼€å§‹ä¸Šä¼ é¡µé¢è·¯å¾„ç»™å…ƒèƒ½åŠ›...`);
    
    // æ„å»ºä¸Šä¼ æ•°æ®
    const uploadData = {
      timestamp: Date.now(),
      operation: operation,
      currentPagePath: router.getState().path,
      targetPagePath: pagePath,
      routerStackLength: router.getLength(),
      backResult: backResult,
      testMetadata: {
        testId: 40,
        testName: 'SUB_ACE_Routing_redirection_0040',
        description: 'router.backæˆåŠŸåä¸Šä¼ é¡µé¢è·¯å¾„ç»™å…ƒèƒ½åŠ›'
      },
      deviceInfo: {
        platform: 'OpenHarmony',
        version: '5.0',
        timestamp: new Date().toISOString()
      }
    };

    // æ¨¡æ‹Ÿå¼‚æ­¥ä¸Šä¼ è¿‡ç¨‹
    return new Promise((resolve, reject) => {
      setTimeout(() => {
        try {
          // æ¨¡æ‹Ÿå…ƒèƒ½åŠ›ä¸Šä¼ æ¥å£
          console.info('=== é¡µé¢è·¯å¾„ä¸Šä¼ ç»™å…ƒèƒ½åŠ› ===');
          console.info('ä¸Šä¼ æ•°æ®:', JSON.stringify(uploadData, null, 2));
          
          // æ¨¡æ‹Ÿä¸Šä¼ æˆåŠŸå›è°ƒ
          const uploadResult = {
            success: true,
            uploadId: `upload_${Date.now()}`,
            uploadTime: new Date().toISOString(),
            dataSize: JSON.stringify(uploadData).length
          };
          
          this.uploadStatus = `âœ… å…ƒèƒ½åŠ›ä¸Šä¼ æˆåŠŸ\nä¸Šä¼ ID: ${uploadResult.uploadId}`;
          this.addLog(`é¡µé¢è·¯å¾„å·²æˆåŠŸä¸Šä¼ ç»™å…ƒèƒ½åŠ›`);
          this.addLog(`ä¸Šä¼ ç»“æœ: ${JSON.stringify(uploadResult)}`);
          
          resolve(uploadResult);
        } catch (err) {
          this.uploadStatus = `âŒ å…ƒèƒ½åŠ›ä¸Šä¼ å¤±è´¥: ${JSON.stringify(err)}`;
          this.addLog(`é¡µé¢è·¯å¾„ä¸Šä¼ å¤±è´¥: ${JSON.stringify(err)}`);
          reject(err);
        }
      }, 800);
    });
  }

  // æ‰§è¡Œ router.back å¹¶åœ¨æˆåŠŸåä¸Šä¼ é¡µé¢è·¯å¾„
  executeBackAndUpload() {
    this.addLog('å‡†å¤‡æ‰§è¡Œ router.back æ“ä½œ...');
    this.backStatus = 'ğŸ”„ æ­£åœ¨æ‰§è¡Œ router.back...';
    
    // è·å–å½“å‰é¡µé¢è·¯å¾„ä¿¡æ¯
    const currentState = router.getState();
    const currentPath = currentState.path;
    const beforeLength = router.getLength();
    
    this.addLog(`æ‰§è¡Œbackå‰ - é¡µé¢è·¯å¾„: ${currentPath}, æ ˆæ·±åº¦: ${beforeLength}`);
    
    // ä½¿ç”¨ Promise æ–¹å¼æ‰§è¡Œ router.back
    router.back()
      .then(() => {
        this.backStatus = 'âœ… router.back æ‰§è¡ŒæˆåŠŸ';
        this.addLog('router.back æ‰§è¡ŒæˆåŠŸ');
        
        // router.back æˆåŠŸåï¼Œä¸Šä¼ é¡µé¢è·¯å¾„ç»™å…ƒèƒ½åŠ›
        this.uploadPagePathToMetaAbility(
          currentPath || 'unknown', 
          'router.back', 
          {
            success: true,
            beforeLength: beforeLength,
            afterLength: router.getLength(),
            executionTime: Date.now()
          }
        ).then((uploadResult) => {
          this.addLog('é¡µé¢è·¯å¾„ä¸Šä¼ å®Œæˆï¼Œæµ‹è¯•æˆåŠŸ');
          console.info('å®Œæ•´æµ‹è¯•æµç¨‹å®Œæˆ:', uploadResult);
        }).catch((uploadError) => {
          this.addLog(`é¡µé¢è·¯å¾„ä¸Šä¼ å¤±è´¥: ${JSON.stringify(uploadError)}`);
        });
        
      })
      .catch((err: BusinessError) => {
        this.backStatus = `âŒ router.back æ‰§è¡Œå¤±è´¥: ${err.message}`;
        this.addLog(`router.back æ‰§è¡Œå¤±è´¥: ${err.message}`);
        console.error('router.back å¤±è´¥:', JSON.stringify(err));
        
        // å³ä½¿ back å¤±è´¥ä¹Ÿå°è¯•ä¸Šä¼ é”™è¯¯ä¿¡æ¯
        this.uploadPagePathToMetaAbility(
          currentPath || 'unknown', 
          'router.back', 
          {
            success: false,
            error: err.message,
            beforeLength: beforeLength,
            executionTime: Date.now()
          }
        );
      });
  }

  // ä½¿ç”¨å›è°ƒæ–¹å¼æ‰§è¡Œ router.back
  executeBackWithCallback() {
    this.addLog('ä½¿ç”¨å›è°ƒæ–¹å¼æ‰§è¡Œ router.back...');
    this.backStatus = 'ğŸ”„ æ­£åœ¨ä½¿ç”¨å›è°ƒæ–¹å¼æ‰§è¡Œ router.back...';
    
    const currentState = router.getState();
    const currentPath = currentState.path;
    const beforeLength = router.getLength();
    
    try {
      router.back(undefined, (err) => {
        if (err) {
          this.backStatus = `âŒ å›è°ƒæ–¹å¼ router.back å¤±è´¥: ${err.message}`;
          this.addLog(`å›è°ƒæ–¹å¼ router.back å¤±è´¥: ${err.message}`);
          
          // ä¸Šä¼ å¤±è´¥ä¿¡æ¯
          this.uploadPagePathToMetaAbility(
            currentPath || 'unknown', 
            'router.back_callback', 
            {
              success: false,
              error: err.message,
              beforeLength: beforeLength,
              executionTime: Date.now()
            }
          );
        } else {
          this.backStatus = 'âœ… å›è°ƒæ–¹å¼ router.back æˆåŠŸ';
          this.addLog('å›è°ƒæ–¹å¼ router.back æˆåŠŸ');
          
          // ä¸Šä¼ æˆåŠŸä¿¡æ¯
          this.uploadPagePathToMetaAbility(
            currentPath || 'unknown', 
            'router.back_callback', 
            {
              success: true,
              beforeLength: beforeLength,
              afterLength: router.getLength(),
              executionTime: Date.now()
            }
          );
        }
      });
    } catch (exception) {
      this.backStatus = `âŒ router.back å¼‚å¸¸: ${JSON.stringify(exception)}`;
      this.addLog(`router.back å¼‚å¸¸: ${JSON.stringify(exception)}`);
    }
  }

  build() {
    Column() {
      Text('Routeré‡å®šå‘æµ‹è¯•ç›®æ ‡é¡µé¢')
        .fontSize(22)
        .fontWeight(FontWeight.Bold)
        .fontColor('#007dff')
        .margin({ bottom: 15 })

      Text('âœ… æˆåŠŸè·³è½¬åˆ°ç›®æ ‡é¡µé¢ï¼')
        .fontSize(16)
        .fontColor('#4caf50')
        .fontWeight(FontWeight.Medium)
        .margin({ bottom: 15 })

      // è·¯ç”±æ ˆä¿¡æ¯æ˜¾ç¤º
      Text('å½“å‰è·¯ç”±æ ˆä¿¡æ¯:')
        .fontSize(14)
        .fontWeight(FontWeight.Bold)
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 8 })

      Text(this.routerStackInfo)
        .fontSize(12)
        .textAlign(TextAlign.Center)
        .backgroundColor('#e8f5e8')
        .padding(12)
        .borderRadius(8)
        .margin({ bottom: 15 })
        .width('90%')

      // æ‰§è¡ŒçŠ¶æ€æ˜¾ç¤º
      if (this.backStatus !== '') {
        Text(this.backStatus)
          .fontSize(14)
          .fontColor(
            this.backStatus.includes('âœ…') ? '#4caf50' : 
            this.backStatus.includes('âŒ') ? '#f44336' : '#ff9800'
          )
          .backgroundColor('#f8f9fa')
          .padding(10)
          .borderRadius(8)
          .margin({ bottom: 15 })
          .width('90%')
      }

      // ä¸Šä¼ çŠ¶æ€æ˜¾ç¤º
      if (this.uploadStatus !== '') {
        Text(this.uploadStatus)
          .fontSize(12)
          .fontColor(
            this.uploadStatus.includes('âœ…') ? '#4caf50' : '#f44336'
          )
          .backgroundColor('#f0f8ff')
          .padding(10)
          .borderRadius(8)
          .margin({ bottom: 15 })
          .width('90%')
      }

      // æµ‹è¯•æŒ‰é’®
      Button('æ‰§è¡Œrouter.backå¹¶ä¸Šä¼ è·¯å¾„')
        .onClick(() => {
          this.executeBackAndUpload();
        })
        .width('85%')
        .backgroundColor('#f44336')
        .fontColor('#ffffff')

      Button('å›è°ƒæ–¹å¼router.back')
        .onClick(() => {
          this.executeBackWithCallback();
        })
        .width('85%')
        .backgroundColor('#9c27b0')
        .fontColor('#ffffff')
        .margin({ top: 8 })

      Button('åˆ·æ–°é¡µé¢ä¿¡æ¯')
        .onClick(() => {
          this.loadReceivedParams();
          this.updateRouterStackInfo();
          this.addLog('å·²åˆ·æ–°é¡µé¢ä¿¡æ¯');
        })
        .width('85%')
        .backgroundColor('#607d8b')
        .fontColor('#ffffff')
        .margin({ top: 8 })

      Divider()
        .margin({ top: 15, bottom: 10 })

      // æ¥æ”¶åˆ°çš„å‚æ•°æ˜¾ç¤º
      Text('æ¥æ”¶åˆ°çš„å‚æ•°:')
        .fontSize(14)
        .fontWeight(FontWeight.Bold)
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 8 })

      Scroll() {
        Text(this.receivedParams)
          .fontSize(10)
          .textAlign(TextAlign.Start)
          .backgroundColor('#f5f5f5')
          .padding(8)
          .borderRadius(6)
          .width('100%')
      }
      .width('90%')
      .height(80)
      .margin({ bottom: 15 })

      // æ“ä½œæ—¥å¿—åŒºåŸŸ
      Text('æ“ä½œæ—¥å¿—:')
        .fontSize(14)
        .fontWeight(FontWeight.Bold)
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 8 })

      Scroll() {
        Text(this.operationLog || 'æš‚æ— æ“ä½œè®°å½•')
          .fontSize(11)
          .textAlign(TextAlign.Start)
          .backgroundColor('#f9f9f9')
          .padding(8)
          .borderRadius(6)
          .width('100%')
          .constraintSize({ minHeight: 100, maxHeight: 120 })
      }
      .width('90%')
      .height(120)

      // æµ‹è¯•è¯´æ˜
      Text('æµ‹è¯•è¯´æ˜:')
        .fontSize(12)
        .fontWeight(FontWeight.Bold)
        .alignSelf(ItemAlign.Start)
        .margin({ top: 10, bottom: 5 })

      Text('â€¢ ç‚¹å‡»æŒ‰é’®æ‰§è¡Œ router.back æ“ä½œ\n' +
        'â€¢ router.back æˆåŠŸåè‡ªåŠ¨ä¸Šä¼ é¡µé¢è·¯å¾„\n' +
        'â€¢ éªŒè¯ä¸Šä¼ åˆ°å…ƒèƒ½åŠ›çš„æ•°æ®å®Œæ•´æ€§\n' +
        'â€¢ æ”¯æŒPromiseå’Œå›è°ƒä¸¤ç§æ–¹å¼')
        .fontSize(10)
        .fontColor('#666666')
        .textAlign(TextAlign.Start)
        .alignSelf(ItemAlign.Start)
        .lineHeight(15)

    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Start)
    .padding(15)
    .scrollable(ScrollDirection.Vertical)
  }
}
