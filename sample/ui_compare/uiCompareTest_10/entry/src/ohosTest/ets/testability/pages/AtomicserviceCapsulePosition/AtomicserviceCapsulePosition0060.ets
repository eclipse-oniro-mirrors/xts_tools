/**
 * Copyright (c) 2025 Shenzhen Kaihong Digital Industry Development Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import { UIContext } from '@kit.ArkUI';

@Entry
@Component
struct AtomicserviceCapsulePosition0060 {
  @State heightValue: number = 0;
  @State errorInfo: string = '';
  @State showOverlay: boolean = false;
  private uiContext: UIContext | null = null;

  aboutToAppear(): void {
    setTimeout(() => {
      this.getCapsuleHeight();
    }, 500);
  }

  getCapsuleHeight(): void {
    try {
      this.uiContext = this.getUIContext();
      if (this.uiContext) {
        const atomicServiceBar = this.uiContext.getAtomicServiceBar();
        console.info('atomicServiceBar:', atomicServiceBar);
        
        if (atomicServiceBar) {
          const barRect = atomicServiceBar.getBarRect();
          console.info('barRect:', JSON.stringify(barRect));
          
          if (barRect) {
            this.heightValue = Number(barRect.height) || 0;
            
            if (this.heightValue === 0) {
              this.errorInfo = 'èƒ¶å›Šé«˜åº¦ä¸º0ï¼Œå¯èƒ½èƒ¶å›Šä¸å¯è§';
            } else {
              this.errorInfo = '';
            }
            console.info('èƒ¶å›Šé«˜åº¦:', this.heightValue);
          } else {
            this.errorInfo = 'getBarRectè¿”å›žnull';
            console.warn('getBarRectè¿”å›žnull');
          }
        } else {
          this.errorInfo = 'AtomicServiceBarä¸å¯ç”¨ï¼Œå¯èƒ½ä¸æ˜¯åŽŸå­åŒ–æœåŠ¡çŽ¯å¢ƒ';
          console.warn('AtomicServiceBarä¸å¯ç”¨');
        }
      } else {
        this.errorInfo = 'UIContextæœªåˆå§‹åŒ–';
        console.error('UIContextæœªåˆå§‹åŒ–');
      }
    } catch (error) {
      this.errorInfo = `èŽ·å–èƒ¶å›Šé«˜åº¦å¤±è´¥: ${error}`;
      console.error('èŽ·å–èƒ¶å›Šé«˜åº¦å¤±è´¥:', error);
    }
  }

  build() {
    Stack({ alignContent: Alignment.TopStart }) {
      Column({ space: 20 }) {
        Text('èŽ·å–èƒ¶å›Šé«˜åº¦æµ‹è¯•')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .margin({ top: 20 })

        Divider()

        Text('èŽ·å–åˆ°çš„èƒ¶å›Šé«˜åº¦ï¼š')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .margin({ top: 10 })

        Column({ space: 15 }) {
          Row() {
            Text('é«˜åº¦(Height):')
              .fontSize(22)
              .fontWeight(FontWeight.Medium)
              .width('40%')
            Text(`${this.heightValue} px`)
              .fontSize(26)
              .fontColor(this.heightValue > 0 ? Color.Blue : Color.Red)
              .fontWeight(FontWeight.Bold)
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceBetween)
          .padding({ left: 10, right: 10 })
        }
        .width('100%')
        .padding(20)
        .backgroundColor('#F0F8FF')
        .borderRadius(10)
        .border({ width: 2, color: '#1E90FF', style: BorderStyle.Solid })

        if (this.errorInfo) {
          Column() {
            Text('çŠ¶æ€ä¿¡æ¯ï¼š')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.Red)
            
            Text(this.errorInfo)
              .fontSize(14)
              .fontColor(Color.Red)
              .margin({ top: 5 })
          }
          .width('100%')
          .padding(15)
          .backgroundColor('#FFE4E1')
          .borderRadius(8)
          .alignItems(HorizontalAlign.Start)
        }

        Divider()

        Row({ space: 10 }) {
          Button('åˆ·æ–°é«˜åº¦')
            .fontSize(18)
            .width('48%')
            .height(55)
            .backgroundColor('#4CAF50')
            .onClick(() => {
              console.info('=== å¼€å§‹åˆ·æ–°é«˜åº¦ ===');
              this.getCapsuleHeight();
              console.info(`åˆ·æ–°åŽçš„é«˜åº¦å€¼: ${this.heightValue}`);
            })

          Button(this.showOverlay ? 'éšè—æ ‡è®°' : 'æ˜¾ç¤ºæ ‡è®°')
            .fontSize(18)
            .width('48%')
            .height(55)
            .backgroundColor(this.showOverlay ? '#FF9800' : '#2196F3')
            .onClick(() => {
              this.showOverlay = !this.showOverlay;
              console.info('showOverlay:', this.showOverlay);
              console.info('é«˜åº¦:', this.heightValue);
            })
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)

        if (this.showOverlay) {
          Text(`âœ“ æ ‡è®°æ¡†å·²æ˜¾ç¤º ${this.heightValue > 0 ? '(é«˜åº¦=' + this.heightValue + 'px)' : '(æµ‹è¯•é«˜åº¦=40px)'}`)
            .fontSize(15)
            .fontColor(this.heightValue > 0 ? Color.Green : Color.Orange)
            .fontWeight(FontWeight.Bold)
            .textAlign(TextAlign.Center)
            .width('100%')
            .padding(10)
            .backgroundColor(this.heightValue > 0 ? '#E8F5E9' : '#FFF3E0')
            .borderRadius(8)
        }

        Divider()

        Column({ space: 10 }) {
          Text('ðŸ“ é«˜åº¦è¯´æ˜Ž')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .width('100%')
          
          Text('â€¢ é«˜åº¦(Height)ï¼šèƒ¶å›ŠæŒ‰é’®çš„åž‚ç›´å°ºå¯¸')
            .fontSize(14)
            .width('100%')
          
          Text('â€¢ å…¸åž‹å€¼ï¼šçº¦30-40pxï¼ˆèƒ¶å›ŠæŒ‰é’®çš„æ ‡å‡†é«˜åº¦ï¼‰')
            .fontSize(14)
            .width('100%')
          
          Text('â€¢ æµ‹è¯•æ–¹æ³•ï¼šç‚¹å‡»"åˆ·æ–°é«˜åº¦"æŸ¥çœ‹æ•°å€¼ï¼Œç‚¹å‡»"æ˜¾ç¤ºæ ‡è®°"æŸ¥çœ‹é«˜åº¦æ ‡è®°æ¡†')
            .fontSize(14)
            .width('100%')
        }
        .alignItems(HorizontalAlign.Start)
        .width('100%')
        .padding(15)
        .backgroundColor('#FFF9C4')
        .borderRadius(8)
      }
      .width('100%')
      .height('100%')
      .padding(20)
      .backgroundColor(Color.White)

      if (this.showOverlay) {
        if (this.heightValue > 0) {
          Column()
            .width(100)
            .height(this.heightValue)
            .backgroundColor('rgba(255, 0, 0, 0.3)')
            .border({ width: 3, color: Color.Red, style: BorderStyle.Solid })
            .position({ x: 50, y: 150 })
            .zIndex(999)
          
          Text(`é«˜åº¦=${this.heightValue}px`)
            .fontSize(14)
            .fontColor(Color.White)
            .backgroundColor(Color.Red)
            .padding(5)
            .position({ x: 160, y: 150 })
            .zIndex(999)
        } else {
          Column()
            .width(100)
            .height(40)
            .backgroundColor('rgba(255, 0, 0, 0.3)')
            .border({ width: 3, color: Color.Red, style: BorderStyle.Solid })
            .position({ x: 50, y: 150 })
            .zIndex(999)
          
          Text('æµ‹è¯•æ ‡è®°æ¡† é«˜åº¦=40px')
            .fontSize(12)
            .fontColor(Color.White)
            .backgroundColor(Color.Red)
            .padding(5)
            .position({ x: 160, y: 150 })
            .zIndex(999)
        }
      }
    }
    .width('100%')
    .height('100%')
  }
}

