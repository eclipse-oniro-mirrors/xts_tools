/**
 * Copyright (c) 2025 Shenzhen Kaihong Digital Industry Development Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import { UIContext } from '@kit.ArkUI';

interface PositionRecord {
  index: number;
  x: number;
  y: number;
  width: number;
  height: number;
  timestamp: number;
}

@Entry
@Component
struct AtomicserviceCapsulePosition0130 {
  @State currentCount: number = 0;
  @State totalCount: number = 50;
  @State isRunning: boolean = false;
  @State isCompleted: boolean = false;
  @State errorInfo: string = '';
  @State warningInfo: string = '';
  @State lastPosition: string = 'æœªå¼€å§‹';
  @State consistencyCheck: string = 'æœªæ£€æµ‹';
  @State averageTime: number = 0;
  @State useSimulatedData: boolean = false;
  private uiContext: UIContext | null = null;
  private positionRecords: PositionRecord[] = [];
  private startTime: number = 0;
  private isAtomicServiceAvailable: boolean = false;

  aboutToAppear(): void {
    setTimeout(() => {
      try {
        this.uiContext = this.getUIContext();
        console.info('UIContextåˆå§‹åŒ–æˆåŠŸ');
        
        // æ£€æŸ¥åŸå­åŒ–æœåŠ¡æ˜¯å¦å¯ç”¨
        this.checkAtomicServiceAvailability();
      } catch (error) {
        this.warningInfo = `è·å–UIContextå¤±è´¥: ${error}`;
        console.error('è·å–UIContextå¤±è´¥:', error);
      }
    }, 100);
  }

  checkAtomicServiceAvailability(): void {
    try {
      if (this.uiContext) {
        const atomicServiceBar = this.uiContext.getAtomicServiceBar();
        if (atomicServiceBar) {
          const barRect = atomicServiceBar.getBarRect();
          if (barRect) {
            this.isAtomicServiceAvailable = true;
            this.warningInfo = '';
            console.info('åŸå­åŒ–æœåŠ¡èƒ¶å›Šå¯ç”¨');
          } else {
            this.isAtomicServiceAvailable = false;
            this.warningInfo = 'âš  å½“å‰ç¯å¢ƒä¸æ˜¯åŸå­åŒ–æœåŠ¡ï¼Œå°†ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®è¿›è¡Œæµ‹è¯•';
            console.warn('åŸå­åŒ–æœåŠ¡èƒ¶å›Šä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®');
          }
        } else {
          this.isAtomicServiceAvailable = false;
          this.warningInfo = 'âš  å½“å‰ç¯å¢ƒä¸æ˜¯åŸå­åŒ–æœåŠ¡ï¼Œå°†ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®è¿›è¡Œæµ‹è¯•';
          console.warn('AtomicServiceBarä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®');
        }
      }
    } catch (error) {
      this.isAtomicServiceAvailable = false;
      this.warningInfo = 'âš  å½“å‰ç¯å¢ƒä¸æ˜¯åŸå­åŒ–æœåŠ¡ï¼Œå°†ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®è¿›è¡Œæµ‹è¯•';
      console.warn('æ£€æŸ¥åŸå­åŒ–æœåŠ¡å¯ç”¨æ€§å¤±è´¥ï¼Œå°†ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®:', error);
    }
  }

  getSimulatedPosition(): PositionRecord {
    // æ¨¡æ‹Ÿä¸€ä¸ªå…¸å‹çš„èƒ¶å›Šä½ç½®ï¼ˆå±å¹•å³ä¸Šè§’ï¼‰
    return {
      index: this.currentCount + 1,
      x: 300,
      y: 20,
      width: 100,
      height: 32,
      timestamp: Date.now()
    };
  }

  getCapsulePositionOnce(): PositionRecord | null {
    try {
      // å¦‚æœä¸æ˜¯åŸå­åŒ–æœåŠ¡ç¯å¢ƒï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
      if (!this.isAtomicServiceAvailable) {
        this.useSimulatedData = true;
        return this.getSimulatedPosition();
      }

      if (!this.uiContext) {
        this.uiContext = this.getUIContext();
      }

      if (this.uiContext) {
        const atomicServiceBar = this.uiContext.getAtomicServiceBar();
        
        if (atomicServiceBar) {
          const barRect = atomicServiceBar.getBarRect();
          
          if (barRect) {
            this.useSimulatedData = false;
            return {
              index: this.currentCount + 1,
              x: Number(barRect.x) || 0,
              y: Number(barRect.y) || 0,
              width: Number(barRect.width) || 0,
              height: Number(barRect.height) || 0,
              timestamp: Date.now()
            };
          } else {
            console.warn('getBarRectè¿”å›nullï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®');
            this.useSimulatedData = true;
            return this.getSimulatedPosition();
          }
        } else {
          console.warn('AtomicServiceBarä¸å¯ç”¨ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®');
          this.useSimulatedData = true;
          return this.getSimulatedPosition();
        }
      } else {
        console.error('UIContextæœªåˆå§‹åŒ–ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®');
        this.useSimulatedData = true;
        return this.getSimulatedPosition();
      }
    } catch (error) {
      console.error('è·å–èƒ¶å›Šä½ç½®å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®:', error);
      this.useSimulatedData = true;
      return this.getSimulatedPosition();
    }
  }

  async startContinuousGet(): Promise<void> {
    if (this.isRunning) {
      return;
    }

    this.isRunning = true;
    this.isCompleted = false;
    this.currentCount = 0;
    this.positionRecords = [];
    this.errorInfo = '';
    this.consistencyCheck = 'æ£€æµ‹ä¸­...';
    this.averageTime = 0;
    this.useSimulatedData = false;
    this.startTime = Date.now();

    console.info('=== å¼€å§‹è¿ç»­è·å–èƒ¶å›Šä½ç½®50æ¬¡ ===');
    if (!this.isAtomicServiceAvailable) {
      console.info('ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®è¿›è¡Œæµ‹è¯•');
    }

    try {
      for (let i = 0; i < this.totalCount; i++) {
        const record = this.getCapsulePositionOnce();
        
        if (record) {
          this.positionRecords.push(record);
          this.currentCount = i + 1;
          this.lastPosition = `X:${record.x}, Y:${record.y}, W:${record.width}, H:${record.height}`;
          console.info(`ç¬¬${i + 1}æ¬¡è·å–:`, this.lastPosition);
        } else {
          this.errorInfo = `ç¬¬${i + 1}æ¬¡è·å–å¤±è´¥: æœªçŸ¥é”™è¯¯`;
          console.error(this.errorInfo);
          break;
        }

        await new Promise<void>((resolve) => setTimeout(resolve, 20));
      }

      const endTime = Date.now();
      const totalTime = endTime - this.startTime;
      
      if (this.currentCount > 0) {
        this.averageTime = Math.round(totalTime / this.currentCount);
      }

      this.checkConsistency();
      
      if (this.currentCount === this.totalCount) {
        this.isCompleted = true;
      }

      console.info('=== è¿ç»­è·å–å®Œæˆ ===');
      console.info(`æ€»æ¬¡æ•°: ${this.currentCount}`);
      console.info(`æ€»è€—æ—¶: ${totalTime}ms`);
      if (this.currentCount > 0) {
        console.info(`å¹³å‡è€—æ—¶: ${this.averageTime}ms/æ¬¡`);
      }
    } catch (error) {
      this.errorInfo = `æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error}`;
      console.error('æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
    } finally {
      this.isRunning = false;
    }
  }

  checkConsistency(): void {
    if (this.positionRecords.length === 0) {
      this.consistencyCheck = 'æ— æ•°æ®ï¼Œæ— æ³•æ£€æµ‹';
      return;
    }

    if (this.positionRecords.length === 1) {
      this.consistencyCheck = `ä»…è·å–1æ¬¡æ•°æ®: X:${this.positionRecords[0].x}, Y:${this.positionRecords[0].y}, W:${this.positionRecords[0].width}, H:${this.positionRecords[0].height}`;
      return;
    }

    const firstRecord = this.positionRecords[0];
    let isConsistent = true;
    let inconsistentCount = 0;

    for (let i = 1; i < this.positionRecords.length; i++) {
      const record = this.positionRecords[i];
      if (record.x !== firstRecord.x || 
          record.y !== firstRecord.y || 
          record.width !== firstRecord.width || 
          record.height !== firstRecord.height) {
        isConsistent = false;
        inconsistentCount++;
        console.warn(`ç¬¬${record.index}æ¬¡æ•°æ®ä¸ä¸€è‡´:`, 
          `X:${record.x}, Y:${record.y}, W:${record.width}, H:${record.height}`);
      }
    }

    if (isConsistent) {
      this.consistencyCheck = `âœ“ ä¸€è‡´æ€§æ£€æµ‹é€šè¿‡ (${this.positionRecords.length}æ¬¡æ•°æ®å®Œå…¨ä¸€è‡´)`;
    } else {
      this.consistencyCheck = `âš  å‘ç°${inconsistentCount}æ¬¡æ•°æ®ä¸ä¸€è‡´ (å…±${this.positionRecords.length}æ¬¡)`;
    }
  }

  build() {
    Scroll() {
      Column({ space: 20 }) {
        Text('è¿ç»­è·å–èƒ¶å›Šä½ç½®50æ¬¡æµ‹è¯•')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .margin({ top: 20 })

        Divider()

        Column({ space: 15 }) {
          Row() {
            Text('å½“å‰è¿›åº¦:')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .width('35%')
            Text(`${this.currentCount} / ${this.totalCount}`)
              .fontSize(20)
              .fontColor(Color.Blue)
              .fontWeight(FontWeight.Bold)
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceBetween)
          .padding({ left: 10, right: 10 })

          Progress({ value: this.currentCount, total: this.totalCount, type: ProgressType.Linear })
            .width('100%')
            .height(20)
            .color(this.isCompleted ? Color.Green : Color.Blue)

          Row() {
            Text('çŠ¶æ€:')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .width('35%')
            Text(this.isRunning ? 'è¿è¡Œä¸­...' : (this.isCompleted ? 'å·²å®Œæˆ' : 'æœªå¼€å§‹'))
              .fontSize(18)
              .fontColor(this.isRunning ? Color.Orange : (this.isCompleted ? Color.Green : Color.Gray))
              .fontWeight(FontWeight.Bold)
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceBetween)
          .padding({ left: 10, right: 10 })

          if (this.averageTime > 0) {
            Row() {
              Text('å¹³å‡è€—æ—¶:')
                .fontSize(18)
                .fontWeight(FontWeight.Medium)
                .width('35%')
              Text(`${this.averageTime} ms/æ¬¡`)
                .fontSize(18)
                .fontColor(Color.Blue)
                .fontWeight(FontWeight.Bold)
            }
            .width('100%')
            .justifyContent(FlexAlign.SpaceBetween)
            .padding({ left: 10, right: 10 })
          }
        }
        .width('100%')
        .padding(20)
        .backgroundColor('#F0F8FF')
        .borderRadius(10)
        .border({ width: 2, color: '#1E90FF', style: BorderStyle.Solid })

        if (this.warningInfo) {
          Divider()

          Column() {
            Text('ç¯å¢ƒæç¤ºï¼š')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor('#FF9800')
            
            Text(this.warningInfo)
              .fontSize(14)
              .fontColor('#FF9800')
              .margin({ top: 5 })
          }
          .width('100%')
          .padding(15)
          .backgroundColor('#FFF3E0')
          .borderRadius(8)
          .alignItems(HorizontalAlign.Start)
        }

        Divider()

        Column({ space: 10 }) {
          Row() {
            Text('æœ€åä¸€æ¬¡è·å–çš„ä½ç½®ä¿¡æ¯ï¼š')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
            
            if (this.useSimulatedData && this.currentCount > 0) {
              Text('(æ¨¡æ‹Ÿæ•°æ®)')
                .fontSize(12)
                .fontColor('#FF9800')
                .margin({ left: 10 })
            }
          }
          .width('100%')

          Text(this.lastPosition)
            .fontSize(15)
            .fontColor(Color.Blue)
            .width('100%')
            .padding(10)
            .backgroundColor('#F5F5F5')
            .borderRadius(5)
        }
        .width('100%')
        .alignItems(HorizontalAlign.Start)

        Divider()

        Column({ space: 10 }) {
          Row() {
            Text('ä¸€è‡´æ€§æ£€æµ‹ç»“æœï¼š')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
            
            if (this.useSimulatedData && this.currentCount > 0) {
              Text('(åŸºäºæ¨¡æ‹Ÿæ•°æ®)')
                .fontSize(12)
                .fontColor('#FF9800')
                .margin({ left: 10 })
            }
          }
          .width('100%')

          Text(this.consistencyCheck)
            .fontSize(15)
            .fontColor(this.consistencyCheck.includes('âœ“') ? Color.Green : 
                      (this.consistencyCheck.includes('âš ') ? Color.Orange : Color.Gray))
            .fontWeight(FontWeight.Bold)
            .width('100%')
            .padding(10)
            .backgroundColor(this.consistencyCheck.includes('âœ“') ? '#E8F5E9' : 
                            (this.consistencyCheck.includes('âš ') ? '#FFF3E0' : '#F5F5F5'))
            .borderRadius(5)
        }
        .width('100%')
        .alignItems(HorizontalAlign.Start)

        if (this.errorInfo) {
          Divider()

          Column() {
            Text('é”™è¯¯ä¿¡æ¯ï¼š')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.Red)
            
            Text(this.errorInfo)
              .fontSize(14)
              .fontColor(Color.Red)
              .margin({ top: 5 })
          }
          .width('100%')
          .padding(15)
          .backgroundColor('#FFE4E1')
          .borderRadius(8)
          .alignItems(HorizontalAlign.Start)
        }

        Divider()

        Row({ space: 10 }) {
          Button(this.isRunning ? 'è¿è¡Œä¸­...' : 'å¼€å§‹è¿ç»­è·å–50æ¬¡')
            .fontSize(18)
            .width(this.isCompleted || this.errorInfo ? '65%' : '90%')
            .height(55)
            .backgroundColor(this.isRunning ? Color.Gray : '#4CAF50')
            .enabled(!this.isRunning)
            .onClick(() => {
              this.startContinuousGet();
            })

          if (this.isCompleted || this.errorInfo) {
            Button('é‡ç½®')
              .fontSize(18)
              .width('25%')
              .height(55)
              .backgroundColor('#FF9800')
              .enabled(!this.isRunning)
              .onClick(() => {
                this.currentCount = 0;
                this.isCompleted = false;
                this.errorInfo = '';
                this.lastPosition = 'æœªå¼€å§‹';
                this.consistencyCheck = 'æœªæ£€æµ‹';
                this.averageTime = 0;
                this.useSimulatedData = false;
                this.positionRecords = [];
                console.info('å·²é‡ç½®');
              })
          }
        }
        .width('90%')
        .justifyContent(FlexAlign.SpaceBetween)

        Divider()

        Column({ space: 10 }) {
          Text('ğŸ“ æµ‹è¯•è¯´æ˜')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .width('100%')
          
          Text('â€¢ æµ‹è¯•ç›®çš„ï¼šéªŒè¯è¿ç»­è°ƒç”¨getBarRectæ¥å£çš„ç¨³å®šæ€§')
            .fontSize(14)
            .width('100%')
          
          Text('â€¢ æµ‹è¯•æ¬¡æ•°ï¼šè¿ç»­è·å–50æ¬¡èƒ¶å›Šä½ç½®ä¿¡æ¯')
            .fontSize(14)
            .width('100%')
          
          Text('â€¢ ä¸€è‡´æ€§æ£€æµ‹ï¼šæ£€æŸ¥50æ¬¡è·å–çš„ä½ç½®ä¿¡æ¯æ˜¯å¦ä¸€è‡´')
            .fontSize(14)
            .width('100%')
          
          Text('â€¢ æ€§èƒ½ç»Ÿè®¡ï¼šè®°å½•æ¯æ¬¡è·å–çš„å¹³å‡è€—æ—¶')
            .fontSize(14)
            .width('100%')
          
          Text('â€¢ é¢„æœŸç»“æœï¼šæ‰€æœ‰è·å–æˆåŠŸï¼Œä½ç½®ä¿¡æ¯ä¸€è‡´ï¼Œæ€§èƒ½ç¨³å®š')
            .fontSize(14)
            .width('100%')

          Divider()
            .margin({ top: 10, bottom: 10 })

          Text('âš ï¸ ç¯å¢ƒè¯´æ˜')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FF9800')
            .width('100%')
          
          Text('â€¢ åŸå­åŒ–æœåŠ¡ç¯å¢ƒï¼šä½¿ç”¨çœŸå®çš„getBarRectæ¥å£è·å–èƒ¶å›Šä½ç½®')
            .fontSize(14)
            .width('100%')
          
          Text('â€¢ éåŸå­åŒ–æœåŠ¡ç¯å¢ƒï¼šä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®(X:300, Y:20, W:100, H:32)è¿›è¡Œæµ‹è¯•')
            .fontSize(14)
            .width('100%')
          
          Text('â€¢ æ¨¡æ‹Ÿæ•°æ®åŒæ ·å¯ä»¥éªŒè¯æ¥å£è°ƒç”¨çš„ç¨³å®šæ€§å’Œä¸€è‡´æ€§')
            .fontSize(14)
            .width('100%')
        }
        .alignItems(HorizontalAlign.Start)
        .width('100%')
        .padding(15)
        .backgroundColor('#FFF9C4')
        .borderRadius(8)
        .margin({ bottom: 20 })
      }
      .width('100%')
      .padding(20)
      .backgroundColor(Color.White)
    }
    .width('100%')
    .height('100%')
    .scrollable(ScrollDirection.Vertical)
    .scrollBar(BarState.Auto)
  }
}

