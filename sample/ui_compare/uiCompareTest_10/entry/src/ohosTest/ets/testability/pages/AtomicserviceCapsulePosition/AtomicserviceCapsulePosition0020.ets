/**
 * Copyright (c) 2025 Shenzhen Kaihong Digital Industry Development Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import { UIContext } from '@kit.ArkUI';

@Entry
@Component
struct AtomicserviceCapsulePosition0020 {
  @State xPosition: number = 0;
  @State yPosition: number = 0;
  @State widthValue: number = 0;
  @State heightValue: number = 0;
  @State showOverlay: boolean = false;
  @State errorInfo: string = '';
  private uiContext: UIContext | null = null;

  aboutToAppear(): void {
    setTimeout(() => {
      this.getCapsulePosition();
    }, 500);
  }

  getCapsulePosition(): void {
    try {
      this.uiContext = this.getUIContext();
      if (this.uiContext) {
        const atomicServiceBar = this.uiContext.getAtomicServiceBar();
        console.info('atomicServiceBar:', atomicServiceBar);
        
        if (atomicServiceBar) {
          const barRect = atomicServiceBar.getBarRect();
          console.info('barRect:', JSON.stringify(barRect));
          
          if (barRect) {
            this.xPosition = Number(barRect.x) || 0;
            this.yPosition = Number(barRect.y) || 0;
            this.widthValue = Number(barRect.width) || 0;
            this.heightValue = Number(barRect.height) || 0;
            
            if (this.xPosition === 0 && this.yPosition === 0 && this.widthValue === 0 && this.heightValue === 0) {
              this.errorInfo = 'èƒ¶å›Šä½ç½®ä¿¡æ¯å…¨ä¸º0ï¼Œå¯èƒ½èƒ¶å›Šä¸å¯è§';
            } else {
              this.errorInfo = '';
            }
            console.info('èƒ¶å›Šä½ç½®ä¿¡æ¯:', `x:${this.xPosition}, y:${this.yPosition}, w:${this.widthValue}, h:${this.heightValue}`);
          } else {
            this.errorInfo = 'getBarRectè¿”å›žnull';
            console.warn('getBarRectè¿”å›žnull');
          }
        } else {
          this.errorInfo = 'AtomicServiceBarä¸å¯ç”¨ï¼Œå¯èƒ½ä¸æ˜¯åŽŸå­åŒ–æœåŠ¡çŽ¯å¢ƒ';
          console.warn('AtomicServiceBarä¸å¯ç”¨');
        }
      } else {
        this.errorInfo = 'UIContextæœªåˆå§‹åŒ–';
        console.error('UIContextæœªåˆå§‹åŒ–');
      }
    } catch (error) {
      this.errorInfo = `èŽ·å–èƒ¶å›Šä½ç½®å¤±è´¥: ${error}`;
      console.error('èŽ·å–èƒ¶å›Šä½ç½®å¤±è´¥:', error);
    }
  }

  build() {
    Stack({ alignContent: Alignment.TopStart }) {
      Column({ space: 20 }) {
        Text('èƒ¶å›Šä½ç½®ä¿¡æ¯æµ‹è¯•')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .margin({ top: 20 })

        Divider()

        Text('èŽ·å–åˆ°çš„èƒ¶å›Šä½ç½®ä¿¡æ¯ï¼š')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .margin({ top: 10 })

        Column({ space: 15 }) {
          Row() {
            Text('Xåæ ‡:')
              .fontSize(20)
              .fontWeight(FontWeight.Medium)
              .width('35%')
            Text(`${this.xPosition} px`)
              .fontSize(22)
              .fontColor(this.xPosition > 0 ? Color.Blue : Color.Red)
              .fontWeight(FontWeight.Bold)
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceBetween)
          .padding({ left: 10, right: 10 })

          Row() {
            Text('Yåæ ‡:')
              .fontSize(20)
              .fontWeight(FontWeight.Medium)
              .width('35%')
            Text(`${this.yPosition} px`)
              .fontSize(22)
              .fontColor(this.yPosition > 0 ? Color.Blue : Color.Red)
              .fontWeight(FontWeight.Bold)
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceBetween)
          .padding({ left: 10, right: 10 })

          Row() {
            Text('å®½åº¦(Width):')
              .fontSize(20)
              .fontWeight(FontWeight.Medium)
              .width('35%')
            Text(`${this.widthValue} px`)
              .fontSize(22)
              .fontColor(this.widthValue > 0 ? Color.Blue : Color.Red)
              .fontWeight(FontWeight.Bold)
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceBetween)
          .padding({ left: 10, right: 10 })

          Row() {
            Text('é«˜åº¦(Height):')
              .fontSize(20)
              .fontWeight(FontWeight.Medium)
              .width('35%')
            Text(`${this.heightValue} px`)
              .fontSize(22)
              .fontColor(this.heightValue > 0 ? Color.Blue : Color.Red)
              .fontWeight(FontWeight.Bold)
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceBetween)
          .padding({ left: 10, right: 10 })
        }
        .width('100%')
        .padding(20)
        .backgroundColor('#F0F8FF')
        .borderRadius(10)
        .border({ width: 2, color: '#1E90FF', style: BorderStyle.Solid })

        if (this.errorInfo) {
          Column() {
            Text('çŠ¶æ€ä¿¡æ¯ï¼š')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.Red)
            
            Text(this.errorInfo)
              .fontSize(14)
              .fontColor(Color.Red)
              .margin({ top: 5 })
          }
          .width('100%')
          .padding(15)
          .backgroundColor('#FFE4E1')
          .borderRadius(8)
          .alignItems(HorizontalAlign.Start)
        }

        Divider()

        Row({ space: 10 }) {
          Button('åˆ·æ–°ä½ç½®')
            .fontSize(18)
            .width('48%')
            .height(55)
            .backgroundColor('#4CAF50')
            .onClick(() => {
              console.info('=== å¼€å§‹åˆ·æ–°ä½ç½® ===');
              this.getCapsulePosition();
              console.info(`åˆ·æ–°åŽçš„å€¼: x=${this.xPosition}, y=${this.yPosition}, w=${this.widthValue}, h=${this.heightValue}`);
            })

          Button(this.showOverlay ? 'éšè—æ ‡è®°' : 'æ˜¾ç¤ºæ ‡è®°')
            .fontSize(18)
            .width('48%')
            .height(55)
            .backgroundColor(this.showOverlay ? '#FF9800' : '#2196F3')
            .onClick(() => {
              this.showOverlay = !this.showOverlay;
              console.info('showOverlay:', this.showOverlay);
              console.info('ä½ç½®ä¿¡æ¯:', `x:${this.xPosition}, y:${this.yPosition}, w:${this.widthValue}, h:${this.heightValue}`);
            })
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)

        if (this.showOverlay) {
          Text(`âœ“ æ ‡è®°æ¡†å·²æ˜¾ç¤º ${this.widthValue > 0 ? '(ä½ç½®: å±å¹•é¡¶éƒ¨å³ä¸Šè§’)' : '(æµ‹è¯•ä½ç½®: 100, 100)'}`)
            .fontSize(15)
            .fontColor(this.widthValue > 0 ? Color.Green : Color.Orange)
            .fontWeight(FontWeight.Bold)
            .textAlign(TextAlign.Center)
            .width('100%')
            .padding(10)
            .backgroundColor(this.widthValue > 0 ? '#E8F5E9' : '#FFF3E0')
            .borderRadius(8)
        }

        Divider()

        Divider()

        Column({ space: 10 }) {
          Text('ðŸ“ èƒ¶å›Šä½ç½®è¯´æ˜Ž')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .width('100%')
          
          Text('â€¢ ä½ç½®ï¼šå±å¹•é¡¶éƒ¨å³ä¸Šè§’ï¼ˆç³»ç»Ÿçº§ç»„ä»¶ï¼‰')
            .fontSize(14)
            .width('100%')
          
          Text('â€¢ æ˜¾ç¤ºæ¡ä»¶ï¼šåŽŸå­åŒ–æœåŠ¡åº”ç”¨ + API 15+')
            .fontSize(14)
            .width('100%')
          
          Text('â€¢ æµ‹è¯•æ–¹æ³•ï¼šç‚¹å‡»"åˆ·æ–°ä½ç½®"æŸ¥çœ‹æ•°å€¼ï¼Œç‚¹å‡»"æ˜¾ç¤ºæ ‡è®°"éªŒè¯ä½ç½®')
            .fontSize(14)
            .width('100%')
        }
        .alignItems(HorizontalAlign.Start)
        .width('100%')
        .padding(15)
        .backgroundColor('#FFF9C4')
        .borderRadius(8)
      }
      .width('100%')
      .height('100%')
      .padding(20)
      .backgroundColor(Color.White)

      if (this.showOverlay) {
        if (this.widthValue > 0 && this.heightValue > 0) {
          Column()
            .width(this.widthValue)
            .height(this.heightValue)
            .backgroundColor('rgba(255, 0, 0, 0.5)')
            .border({ width: 3, color: Color.Red, style: BorderStyle.Solid })
            .position({ x: this.xPosition, y: this.yPosition })
            .zIndex(999)
        } else {
          Column()
            .width(100)
            .height(50)
            .backgroundColor('rgba(255, 0, 0, 0.5)')
            .border({ width: 3, color: Color.Red, style: BorderStyle.Solid })
            .position({ x: 100, y: 100 })
            .zIndex(999)
          
          Text('æµ‹è¯•æ ‡è®°æ¡†(100,100)')
            .fontSize(12)
            .fontColor(Color.White)
            .backgroundColor(Color.Red)
            .padding(5)
            .position({ x: 100, y: 160 })
            .zIndex(999)
        }
      }
    }
    .width('100%')
    .height('100%')
  }
}

