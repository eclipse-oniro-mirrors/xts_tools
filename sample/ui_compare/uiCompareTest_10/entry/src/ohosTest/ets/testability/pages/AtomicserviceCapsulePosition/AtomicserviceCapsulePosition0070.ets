/**
 * Copyright (c) 2025 Shenzhen Kaihong Digital Industry Development Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import { UIContext } from '@kit.ArkUI';

@Entry
@Component
struct AtomicserviceCapsulePosition0070 {
  @State xPosition: number = 0;
  @State yPosition: number = 0;
  @State errorInfo: string = '';
  @State showOverlay: boolean = false;
  private uiContext: UIContext | null = null;

  aboutToAppear(): void {
    setTimeout(() => {
      this.getCapsuleXY();
    }, 500);
  }

  getCapsuleXY(): void {
    try {
      this.uiContext = this.getUIContext();
      if (this.uiContext) {
        const atomicServiceBar = this.uiContext.getAtomicServiceBar();
        console.info('atomicServiceBar:', atomicServiceBar);
        
        if (atomicServiceBar) {
          const barRect = atomicServiceBar.getBarRect();
          console.info('barRect:', JSON.stringify(barRect));
          
          if (barRect) {
            this.xPosition = Number(barRect.x) || 0;
            this.yPosition = Number(barRect.y) || 0;
            
            if (this.xPosition === 0 && this.yPosition === 0) {
              this.errorInfo = 'èƒ¶å›ŠXã€Yåæ ‡å…¨ä¸º0ï¼Œå¯èƒ½èƒ¶å›Šä¸å¯è§';
            } else {
              this.errorInfo = '';
            }
            console.info('èƒ¶å›ŠXã€Yåæ ‡:', `x:${this.xPosition}, y:${this.yPosition}`);
          } else {
            this.errorInfo = 'getBarRectè¿”å›žnull';
            console.warn('getBarRectè¿”å›žnull');
          }
        } else {
          this.errorInfo = 'AtomicServiceBarä¸å¯ç”¨ï¼Œå¯èƒ½ä¸æ˜¯åŽŸå­åŒ–æœåŠ¡çŽ¯å¢ƒ';
          console.warn('AtomicServiceBarä¸å¯ç”¨');
        }
      } else {
        this.errorInfo = 'UIContextæœªåˆå§‹åŒ–';
        console.error('UIContextæœªåˆå§‹åŒ–');
      }
    } catch (error) {
      this.errorInfo = `èŽ·å–èƒ¶å›ŠXã€Yåæ ‡å¤±è´¥: ${error}`;
      console.error('èŽ·å–èƒ¶å›ŠXã€Yåæ ‡å¤±è´¥:', error);
    }
  }

  build() {
    Stack({ alignContent: Alignment.TopStart }) {
      Column({ space: 20 }) {
        Text('èŽ·å–èƒ¶å›ŠXã€Yåæ ‡æµ‹è¯•')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .margin({ top: 20 })

        Divider()

        Text('èŽ·å–åˆ°çš„èƒ¶å›ŠXã€Yåæ ‡ï¼š')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .margin({ top: 10 })

        Column({ space: 15 }) {
          Row() {
            Text('Xåæ ‡:')
              .fontSize(20)
              .fontWeight(FontWeight.Medium)
              .width('35%')
            Text(`${this.xPosition} px`)
              .fontSize(22)
              .fontColor(this.xPosition > 0 ? Color.Blue : Color.Red)
              .fontWeight(FontWeight.Bold)
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceBetween)
          .padding({ left: 10, right: 10 })

          Row() {
            Text('Yåæ ‡:')
              .fontSize(20)
              .fontWeight(FontWeight.Medium)
              .width('35%')
            Text(`${this.yPosition} px`)
              .fontSize(22)
              .fontColor(this.yPosition > 0 ? Color.Blue : Color.Red)
              .fontWeight(FontWeight.Bold)
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceBetween)
          .padding({ left: 10, right: 10 })
        }
        .width('100%')
        .padding(20)
        .backgroundColor('#F0F8FF')
        .borderRadius(10)
        .border({ width: 2, color: '#1E90FF', style: BorderStyle.Solid })

        if (this.errorInfo) {
          Column() {
            Text('çŠ¶æ€ä¿¡æ¯ï¼š')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.Red)
            
            Text(this.errorInfo)
              .fontSize(14)
              .fontColor(Color.Red)
              .margin({ top: 5 })
          }
          .width('100%')
          .padding(15)
          .backgroundColor('#FFE4E1')
          .borderRadius(8)
          .alignItems(HorizontalAlign.Start)
        }

        Divider()

        Row({ space: 10 }) {
          Button('åˆ·æ–°åæ ‡')
            .fontSize(18)
            .width('48%')
            .height(55)
            .backgroundColor('#4CAF50')
            .onClick(() => {
              console.info('=== å¼€å§‹åˆ·æ–°Xã€Yåæ ‡ ===');
              this.getCapsuleXY();
              console.info(`åˆ·æ–°åŽçš„å€¼: x=${this.xPosition}, y=${this.yPosition}`);
            })

          Button(this.showOverlay ? 'éšè—æ ‡è®°' : 'æ˜¾ç¤ºæ ‡è®°')
            .fontSize(18)
            .width('48%')
            .height(55)
            .backgroundColor(this.showOverlay ? '#FF9800' : '#2196F3')
            .onClick(() => {
              this.showOverlay = !this.showOverlay;
              console.info('showOverlay:', this.showOverlay);
              console.info('Xã€Yåæ ‡:', `x:${this.xPosition}, y:${this.yPosition}`);
            })
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)

        if (this.showOverlay) {
          Text(`âœ“ æ ‡è®°å·²æ˜¾ç¤º ${this.xPosition > 0 || this.yPosition > 0 ? '(ä½ç½®: X=' + this.xPosition + ', Y=' + this.yPosition + ')' : '(æµ‹è¯•ä½ç½®: X=100, Y=50)'}`)
            .fontSize(15)
            .fontColor(this.xPosition > 0 || this.yPosition > 0 ? Color.Green : Color.Orange)
            .fontWeight(FontWeight.Bold)
            .textAlign(TextAlign.Center)
            .width('100%')
            .padding(10)
            .backgroundColor(this.xPosition > 0 || this.yPosition > 0 ? '#E8F5E9' : '#FFF3E0')
            .borderRadius(8)
        }

        Divider()

        Column({ space: 10 }) {
          Text('ðŸ“ Xã€Yåæ ‡è¯´æ˜Ž')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .width('100%')
          
          Text('â€¢ Xåæ ‡ï¼šèƒ¶å›Šè·ç¦»å±å¹•å·¦è¾¹ç¼˜çš„æ°´å¹³è·ç¦»')
            .fontSize(14)
            .width('100%')
          
          Text('â€¢ Yåæ ‡ï¼šèƒ¶å›Šè·ç¦»å±å¹•é¡¶éƒ¨çš„åž‚ç›´è·ç¦»')
            .fontSize(14)
            .width('100%')
          
          Text('â€¢ å…¸åž‹ä½ç½®ï¼šå±å¹•é¡¶éƒ¨å³ä¸Šè§’')
            .fontSize(14)
            .width('100%')
          
          Text('â€¢ æµ‹è¯•æ–¹æ³•ï¼šç‚¹å‡»"åˆ·æ–°åæ ‡"æŸ¥çœ‹æ•°å€¼ï¼Œç‚¹å‡»"æ˜¾ç¤ºæ ‡è®°"æŸ¥çœ‹åå­—æ ‡è®°')
            .fontSize(14)
            .width('100%')
        }
        .alignItems(HorizontalAlign.Start)
        .width('100%')
        .padding(15)
        .backgroundColor('#FFF9C4')
        .borderRadius(8)
      }
      .width('100%')
      .height('100%')
      .padding(20)
      .backgroundColor(Color.White)

      if (this.showOverlay) {
        if (this.xPosition > 0 || this.yPosition > 0) {
          Line()
            .width(3)
            .height('100%')
            .stroke(Color.Red)
            .strokeWidth(3)
            .position({ x: this.xPosition, y: 0 })
            .zIndex(999)
          
          Line()
            .width('100%')
            .height(3)
            .stroke(Color.Red)
            .strokeWidth(3)
            .position({ x: 0, y: this.yPosition })
            .zIndex(999)
          
          Text(`(${this.xPosition}, ${this.yPosition})`)
            .fontSize(14)
            .fontColor(Color.White)
            .backgroundColor(Color.Red)
            .padding(5)
            .position({ x: this.xPosition + 5, y: this.yPosition + 5 })
            .zIndex(999)
        } else {
          Line()
            .width(3)
            .height('100%')
            .stroke(Color.Red)
            .strokeWidth(3)
            .position({ x: 100, y: 0 })
            .zIndex(999)
          
          Line()
            .width('100%')
            .height(3)
            .stroke(Color.Red)
            .strokeWidth(3)
            .position({ x: 0, y: 50 })
            .zIndex(999)
          
          Text('æµ‹è¯•æ ‡è®° (100, 50)')
            .fontSize(12)
            .fontColor(Color.White)
            .backgroundColor(Color.Red)
            .padding(5)
            .position({ x: 105, y: 55 })
            .zIndex(999)
        }
      }
    }
    .width('100%')
    .height('100%')
  }
}

